---
title: "증권사 마이너스대출 구현"
categories:

  - Tech
tags: 
  - 마통
  - 증권사 마이너스대출
  - 증권
  - 금융IT
toc: true
toc_sticky: true
toc_label: 목차
popular: true
---

2008 년 즈음 마이너스 통장이 유행을 했었다. 직장인이 급하게 돈이 필요할때, 가계대출 대신 마이너스통장을 개설하고, 계좌에서 필요할때마다 출금해서 사용하고, 입금하면 자동으로 상환되는 방식의 계좌이다.

잘 알려지지 않았지만, 증권사에도 마이너스 통장이 있다.(대부분 증권사 직원들이 갖고있지만, 널리 사용되고 있지는 않음)

증권사마이너스 통장은 일반적으로 보험 회사에서 증권회사에 모계좌를 개설한 다음, 증권사 고객에게 돈을 빌려주고 이자를 받는 형식의 프로세스를 따른다.

**[프로세스]**

1. 증권사 계좌를 가진 고객이 마이너스 통장 신청
2. 증권사 직원이 보험사에 해당 내용을 fax로 송신 하고, 보험사에선 심사를 마친후 고객의 한도를 설정해줌.
3. 고객이 예수금 이상으로 출금할 경우, 보험사로 전문을 출금금액을 송신한 후, 정상응답 받게된 후 보험사 계좌에서 고객계좌로 대체 입금해 주고, 고객계좌에서 출금금액 만큼 출금됨.
4. 매일 특정시간에 대출받은 계좌에 예수금이 존재하면, 자동으로 보험사로 상환 전문을 송신하고 정상응답을 받게된 후 고객계좌에서 보험사 계좌로 대체 출금 됨.
5. 매월 특정일자에 대출받은 계좌대상으로 보험사에서 이자를 징수하는 전문을 수신하고, 해당 고객계좌에서 보험사 계좌로 대체출금 함.

여기서 전산 개발자로 구현시 고민해야 할 부분은 출금시 보험사로 전문을 송신할 경우 이다.

만약 예수금이 100원인 계좌가, 마이너스통장 대출 약정을 300원 잡았다면, 이 계좌의 출금 가능금액은 예수금100원과 대출가능금 300원을 포함한 400원 이다.

이 계좌에서 200원을 출금 하게 되면, 아래와 같이 거래가 발생한다.

| 거래번호 | 원 거래번호 | 예수금 | 프리론 |
| :------- | :---------- | :----- | :----- |
|          |             | 100    | 300    |
| 1        | 0           | 200    | 200    |
| 2        | 0           | 0      | 200    |

거래가 끝난 후 이 계좌의 출금가능금액은 200원 이다.



보험사 마이너스 대출의 경우, 출금시 보험사로 전문을 송신하고 보험사에서 정상응답이 올 경우만 고객계좌로 입금을 해줘야 한다.
전문을 송신할때 전문 송신내역을 생성하게 되는데, 이때 TRANSACTION을 분리해서 생성해야 한다. 그리고, 출금 TRANSACTION에선 전문 송신내역 테이블을 POLLING (약 10초간 0.1초 간격으로 sleep) 하면서 해당전문의 응답이 정상일 경우만 고객계좌에 입금처리를 해준다.

만약 TRANSACTION을 분리하지 않고 전문 송신내역을 생성할 경우, 전문 수신 프로그램에서 송신내역을 갱신하지 못하게 됨으로 해당 TRANSACTION은 TIME OUT으로 항상 정상처리되지 못하게 된다. (PL SQL에서는 SAVE POINT를 사용해서 TRANSACTION을 관리하며, 프레임웍을 사용하는 개발환경에서는 프레임웍에서 제공하는 트랜젝션 분리 방법으로 구현해야 한다.)
오류응답이 왔을경우, 전문 송신내역에 응답코드를 오류로 바꾸고 , 출금TRANSACTION은 에러로, ROLLBACK 되게 한다.